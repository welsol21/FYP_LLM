services:
  postgres:
    image: postgres:16
    container_name: ela-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-ela}
      POSTGRES_USER: ${POSTGRES_USER:-ela_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ela_pass}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ela_user} -d ${POSTGRES_DB:-ela}"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TORCH_VERSION: ${TORCH_VERSION:-2.6.0}
    container_name: ela-app
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      ELA_DATABASE_URL: ${ELA_DATABASE_URL:-postgresql://ela_user:ela_pass@postgres:5432/ela}
      HF_HOME: /opt/hf-cache
      ELA_CLIENT_DB_PATH: /app/artifacts/client_state.sqlite3
      ELA_RUNTIME_MODE: ${ELA_RUNTIME_MODE:-online}
      ELA_DEPLOYMENT_MODE: ${ELA_DEPLOYMENT_MODE:-local}
      ELA_RUNTIME_HTTP_PORT: 8000
      ELA_SENTENCE_CONTRACT_BACKEND_URL: ${ELA_SENTENCE_CONTRACT_BACKEND_URL:-http://127.0.0.1:8000}
    volumes:
      - inference_results:/app/inference_results
      - artifacts_data:/app/artifacts
      - hf_cache:/opt/hf-cache
    command: >
      bash -lc "python -m ela_pipeline.db.migrate &&
      python -m ela_pipeline.runtime.api_server"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - app
    ports:
      - "${FRONTEND_PORT:-8080}:80"
    healthcheck:
      test: ["CMD-SHELL", "nginx -t >/dev/null 2>&1 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

volumes:
  pgdata:
  inference_results:
  artifacts_data:
  hf_cache:
